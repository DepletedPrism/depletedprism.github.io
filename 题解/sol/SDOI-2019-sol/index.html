<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<title>
  
    SDOI 2019 大赏
  
</title>

<meta name="description" content="从四月开始摸了两周鱼… 感觉不太行, 又滚过来做省选套题了.">
<meta property="og:type" content="article">
<meta property="og:title" content="SDOI 2019 大赏">
<meta property="og:url" content="https://depletedprism.github.io/题解/sol/SDOI-2019-sol/index.html">
<meta property="og:site_name" content="DepletedPrism&#39;s Blog">
<meta property="og:description" content="从四月开始摸了两周鱼… 感觉不太行, 又滚过来做省选套题了.">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-04-28T15:52:25.813Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SDOI 2019 大赏">
<meta name="twitter:description" content="从四月开始摸了两周鱼… 感觉不太行, 又滚过来做省选套题了.">


  <link rel="alternative" href="/atom.xml" title="DepletedPrism&#39;s Blog" type="application/atom+xml">



  <link rel="icon" href="/images/favicon.jpg">


<link rel="stylesheet" href="/perfect-scrollbar/css/perfect-scrollbar.min.css">
<link rel="stylesheet" href="/styles/main.css">


  <!-- Google Analytics -->
  <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-158626830-1', 'auto');
    ga('send', 'pageview');

  </script>
  <!-- End Google Analytics -->





</head>
<body class="monochrome">
  <div class="mobile-header">
  <button class="sidebar-toggle" type="button">
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
  <a class="title" href="/">DepletedPrism&#39;s Blog</a>
</div>

  <div class="main-container">
    <div class="sidebar">
  <div class="header">
    <h1 class="title"><a href="/">DepletedPrism&#39;s Blog</a></h1>
    
      <p class="subtitle">
        知其然而不知其所以然是可悲的.
      </p>
    
    <div class="info">
      <div class="content">
        
        
          <div class="author">DepletedPrism</div>
        
      </div>
      
        <div class="avatar">
          
            <a href="/about"><img src="/images/favicon.jpg"></a>
          
        </div>
      
    </div>
  </div>
  <div class="body">
    
      
        <ul class="nav">
          
            
              <li class="category-list-container">
                <a href="javascript:;">分类</a>
                <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/笔记/">笔记</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/题解/">题解</a><span class="category-list-count">45</span></li></ul>
              </li>
            
          
            
              <li class="tag-list-container">
                <a href="javascript:;">标签</a>
                <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Combinatorics/">Combinatorics</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Data-Structure/">Data Structure</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dynamic-Programming/">Dynamic Programming</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Geometry/">Geometry</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Graph/">Graph</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Greedy/">Greedy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Number-Theory/">Number Theory</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Polynomial/">Polynomial</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Probability-Mean/">Probability & Mean</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/String/">String</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vim/">Vim</a><span class="tag-list-count">1</span></li></ul>
              </li>
            
          
            
              <li class="archive-list-container">
                <a href="javascript:;">归档</a>
                <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/9102/">9102</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">43</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">16</span></li></ul>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="/index.html" title="Homepage">Homepage</a>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="https://github.com/DepletedPrism" title="Github" target="_blank" rel="noopener">Github</a>
              </li>
            
          
            
              <li>
                <a href="https://zyzoj.com" title="ZYZOJ" target="_blank" rel="noopener">ZYZOJ</a>
              </li>
            
          
            
              <li>
                <a href="/atom.xml" title="RSS">RSS</a>
              </li>
            
          
        </ul>
      
    
  </div>
</div>

    <div class="main-content">
      
        <div style="max-width: 1000px">
      
          <article id="post-sol/SDOI-2019-sol" class="article article-type-post">
  
    <h1 class="article-header">
      SDOI 2019 大赏
    </h1>
  
  

  <div class="article-info">
    <span class="article-date">
  2020-04-15
</span>

    
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/题解/">题解</a></li></ul>
	</span>


    

	
  </div>
  <div class="article-entry">
    <hr>
<p>从四月开始摸了两周鱼… 感觉不太行, 又滚过来做省选套题了.</p>
<a id="more"></a>
<h3 id="「SDOI2019」快速查询"><a href="#「SDOI2019」快速查询" class="headerlink" title="「SDOI2019」快速查询"></a>「SDOI2019」快速查询</h3><h4 id="题目链接"><a href="#题目链接" class="headerlink" title="题目链接"></a>题目链接</h4><ul>
<li><a href="https://loj.ac/problem/3110" target="_blank" rel="noopener">https://loj.ac/problem/3110</a></li>
</ul>
<h4 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h4><p><del>这道题有意思的地方在于 T2.</del></p>
<p>显然正解是线性做法. 维护标记 $a$, $b$, $c$, 以及真实值全局和 $s$. 那么, 对于记录的值 $x$, 如果这个位置曾被单点赋值, 其真实值为 $ax + b$. 否则 $x$ 为 $c$.</p>
<p>可以利用离散化处理数列位置标号的问题. 但是离散化做法在实现时有些繁琐的细节, 于是偷懒用了 <code>unordered_map</code>, 每次全局赋值暴力清空 <code>unordered_map</code> = =</p>
<p>具体地, 对于操作</p>
<ol>
<li><p>更新 $s$, 改变记录的 $A_i$, 使其满足 $a A_i + b = \mathrm{val}$, 即 $A_i \equiv  a ^ {-1} \cdot (\mathrm{val} - b) \pmod P$.</p>
</li>
<li><p>更新 $b,\ s$.</p>
</li>
<li><p>更新 $a,\ b,\ s$.</p>
</li>
<li><p>清空 <code>unordered_map</code>, 初始化 $a,\ b,\ s,\ c$. 清空的时间复杂度和 <code>unordered_map</code> 中元素个数有关, 因此复杂度是对的.</p>
</li>
<li><p>在 <code>unordered_map</code> 中查询, 不存在该位置即为 $c$.</p>
</li>
<li><p>返回 $s$ 即可.</p>
</li>
</ol>
<p>1 操作需要用到逆元. 注意到模数不大且是质数, 线性预处理逆元即可.</p>
<p>时间复杂度 $O(tq)$.</p>
<h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><div><div class="fold_hider"><div class="close hider_title">点击显示 / 隐藏 </div></div><div class="fold">
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LOJ #3110</span></span><br><span class="line"><span class="comment">// DeP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cctype&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> IO &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> MAXSIZE = <span class="number">1</span> &lt;&lt; <span class="number">18</span> | <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[MAXSIZE], *p1, *p2;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">Gc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> p1 == p2 &amp;&amp;</span><br><span class="line">            (p2 = (p1 = buf) + fread(buf, <span class="number">1</span>, MAXSIZE, <span class="built_in">stdin</span>), p1 == p2)? EOF: *p1++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(T&amp; x)</span> </span>&#123;</span><br><span class="line">        x = <span class="number">0</span>; <span class="keyword">int</span> f = <span class="number">0</span>, ch = Gc();</span><br><span class="line">        <span class="keyword">while</span> (!<span class="built_in">isdigit</span>(ch)) f |= ch == <span class="string">'-'</span>, ch = Gc();</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">isdigit</span>(ch)) x = x * <span class="number">10</span> + ch - <span class="string">'0'</span>, ch = Gc();</span><br><span class="line">        <span class="keyword">if</span> (f) x = -x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">using</span> IO::read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXQ = <span class="number">1e5</span> + <span class="number">5</span>, P = <span class="number">1e7</span> + <span class="number">19</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Opt</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> opt, idx, val;</span><br><span class="line">&#125; Q[MAXQ];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n, q, t, ans;</span><br><span class="line"><span class="keyword">int</span> inv[P];</span><br><span class="line"><span class="built_in">unordered_map</span>&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; A;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">solve</span><span class="params">(<span class="keyword">const</span> Opt&amp; p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> a = <span class="number">1</span>, b = <span class="number">0</span>, c = <span class="number">0</span>, s = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (p.opt == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (A.count(p.idx) &gt; <span class="number">0</span>)</span><br><span class="line">            s = (s - (<span class="number">1L</span>L * a * A[p.idx] % P + b) % P + P) % P;</span><br><span class="line">        <span class="keyword">else</span> s = (s - (<span class="number">1L</span>L * a * c % P + b) % P + P) % P;</span><br><span class="line">        A[p.idx] = <span class="number">1L</span>L * (p.val - b + P) % P * inv[a] % P;</span><br><span class="line">        s = (s + p.val) % P;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (p.opt == <span class="number">2</span>)</span><br><span class="line">        b = (b + p.val) % P, s = (s + <span class="number">1L</span>L * n * p.val) % P;</span><br><span class="line">    <span class="keyword">if</span> (p.opt == <span class="number">3</span>) &#123;</span><br><span class="line">        a = <span class="number">1L</span>L * a * p.val % P, b = <span class="number">1L</span>L * b * p.val % P;</span><br><span class="line">        s = <span class="number">1L</span>L * s * p.val % P;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (p.opt == <span class="number">4</span>) &#123;</span><br><span class="line">        a = <span class="number">1</span>, b = <span class="number">0</span>, c = p.val, s = <span class="number">1L</span>L * n * p.val % P;</span><br><span class="line">        A.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (p.opt == <span class="number">5</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (A.count(p.idx) &gt; <span class="number">0</span>)</span><br><span class="line">            ans = (ans + (<span class="number">1L</span>L * a * A[p.idx] % P + b) % P) % P;</span><br><span class="line">        <span class="keyword">else</span> ans = (ans + (<span class="number">1L</span>L * a * c % P + b) % P) % P;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (p.opt == <span class="number">6</span>)</span><br><span class="line">        ans = (ans + s) % P;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ONLINE_JUDGE</span></span><br><span class="line">    freopen(<span class="string">"input.in"</span>, <span class="string">"r"</span>, <span class="built_in">stdin</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// input</span></span><br><span class="line">    read(n), read(q);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= q; ++i) &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">int</span> opt, idx, val;</span><br><span class="line">        read(opt), idx = val = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (opt == <span class="number">1</span> || opt == <span class="number">5</span>) read(idx);</span><br><span class="line">        <span class="keyword">if</span> (opt != <span class="number">5</span> &amp;&amp; opt != <span class="number">6</span>) read(val);</span><br><span class="line">        Q[i] = (Opt)&#123; opt, idx, (val % P + P) % P &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// init</span></span><br><span class="line">    inv[<span class="number">0</span>] = inv[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; P; ++i)</span><br><span class="line">        inv[i] = <span class="number">1L</span>L * inv[P % i] * (P - P / i) % P;</span><br><span class="line">    <span class="comment">// output</span></span><br><span class="line">    read(t);</span><br><span class="line">    <span class="keyword">while</span> (t--) &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">int</span> a, b;</span><br><span class="line">        read(a), read(b);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= q; ++j)</span><br><span class="line">            solve(Q[(a + <span class="number">1L</span>L * j * b % q) % q + <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, ans);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>
<h3 id="「SDOI2019」染色"><a href="#「SDOI2019」染色" class="headerlink" title="「SDOI2019」染色"></a>「SDOI2019」染色</h3><p><del>暴论: 题目名称叫 “染色” 的都是毒瘤题</del>.</p>
<h4 id="题目链接-1"><a href="#题目链接-1" class="headerlink" title="题目链接"></a>题目链接</h4><ul>
<li><a href="https://loj.ac/problem/3111" target="_blank" rel="noopener">https://loj.ac/problem/3111</a></li>
</ul>
<h4 id="解题思路-1"><a href="#解题思路-1" class="headerlink" title="解题思路"></a>解题思路</h4><p>毒瘤题, 琢磨了好久也写了好久.</p>
<p>参考了 <a href="https://yhx-12243.github.io/OI-transit/records/lydsy5530%3Blg5359%3Bloj3111.html" target="_blank" rel="noopener">yhx-12243 的题解</a>, 感觉 yhx-12243 讲地非常好.</p>
<p>容易得出一个朴素 DP: 设 $f(i, c_1, c_2)$ 表示处理前 $i$ 列, 第 $i$ 列颜色分别为 $c_1,\ c_2$ 的方案数, 每次转移时枚举颜色.</p>
<p>考虑到 “相邻节点颜色不同” 的限制只约束了颜色不同, 每次枚举所有颜色看起来没有必要. 同时行数很小, 本质不同的情况很少.</p>
<p>从这个角度出发, 只考虑被染色的列. 我们称上下两行任意一格已经被染色的列为关键列. 对于两个 “相邻” 的关键列, 也就是两列间不包含其他的关键列, 其对方案数的贡献只和两列的染色的相对情况, 以及相隔未染色列个数有关.</p>
<p>具体地, 关键列的排布只有以下几种情况. (其中 $x$, $y$ 表示已经确定过的颜色, $w$ 为不同于 $x$, $y$ 的颜色)</p>
<script type="math/tex; mode=display">\begin{bmatrix} x & \ldots & x \\ y & \ldots & y \end{bmatrix} \tag{0}</script><script type="math/tex; mode=display">\begin{bmatrix} x & \ldots & y \\ y & \ldots & x \end{bmatrix} \tag{1}</script><script type="math/tex; mode=display">\begin{bmatrix} x & \ldots & x \\ y & \ldots & w \end{bmatrix},  \begin{bmatrix} x & \ldots & w \\ y & \ldots & y \end{bmatrix} \tag{2}</script><script type="math/tex; mode=display">\begin{bmatrix} x & \ldots & y \\ y & \ldots & w \end{bmatrix},  \begin{bmatrix} x & \ldots & w \\ y & \ldots & x \end{bmatrix} \tag{3}</script><script type="math/tex; mode=display">\begin{bmatrix} x & \ldots & w_1 \\ y & \ldots & w_2 \end{bmatrix} \tag{4}</script><p>那么预处理出两关键列之间的转移. 设 $g(i, s)$ 表示两关键列相隔长度为 $i$, 后一关键列状态为 $s$ 的方案数.</p>
<p>设 $\mathbf{g_i} =\begin{bmatrix} g(i, 0) \\ g(i, 1) \\ g(i, 2) \\ g(i, 3) \\ g(i, 4) \end{bmatrix}$, 大力分类讨论后可以得到转移</p>
<script type="math/tex; mode=display">\mathbf{g_{i + 1}} = \begin{bmatrix} 0 & 1 & 0 & 2(c-2) & (c-2)(c-3) \\ 1 & 0 & 2(c-2) & 0 & (c-2)(c-3) \\ 0 & 1 & c-2 & (c-2) + (c-3) & (c-3)^2 \\ 1 & 0 & (c - 2) + (c - 3) & c-2 & (c-3) ^ 2 \\ 1 & 1 & 2(c-3) & 2(c-3) & c^2 - 7c + 13  \end{bmatrix} \times \mathbf{g_i}</script><p>(其中 $c ^ 2 - 7c + 13$ 由 $(c-2)(c-3) - (c-2) - (c-3)$ 得到)</p>
<p>通过预处理 $g$, 只需枚举关键列, 通过关键列的颜色分布以及关键列相隔距离转移即可得出答案.</p>
<p>具体地, 和 yhx-12243 的题解一样, 将转移分为 brute, open, close, move 四个部分, 具体定义参见上述题解 (</p>
<p>为了表述方便, 记两关键列的颜色的分布情况为 $\begin{bmatrix} l_1 &amp; \ldots &amp; r_1 \\ l_2 &amp; \ldots &amp; r_2 \end{bmatrix}$.</p>
<ol>
<li><p>brute</p>
<p>此时两关键列的情况都唯一, 根据颜色相对情况填上对应情况的数值即可.</p>
</li>
<li><p>open</p>
<p>不妨假设 $r_1$ 为已确定的颜色, 另一种情况同这个情况类似.</p>
<p>通过比较 $r_1$ 和 $l_1,\ l_2$ 的相等关系, 判定其是否属于情况 2 / 3, 以及枚举 $r_2$ 取值, 并额外处理 $r_2$ 和 $l_1,\ l_2$ 相等的情况.</p>
</li>
<li><p>close</p>
<p>不妨假设 $l_1$ 为已确定的颜色, 另一种情况同这个情况类似.</p>
<p>同 open 的情况类似, 不过在处理 $l_2$ 和 $r_1,\ r_2$ 相等情况时, 需减去 $l_1$ 时已经计算的部分避免算重.</p>
</li>
<li><p>move</p>
<p>最为繁琐的情况. <del>同时也是前两档部分分的组成</del></p>
<p>首先需要判定组成的局面构成情况 2 或是情况 3. 接着用类似 open / close 的方法讨论颜色, 注意减去算重的部分.</p>
</li>
</ol>
<p>此外还需要处理首尾关键列的部分, 以及不存在关键列, 或是无解的一些特殊情况, 详细式子相对容易理解, 自行参考代码 (</p>
<p>综上, 得出了时间复杂度为 $O(nc)$ 的做法.</p>
<p>可以发现, 转移时的操作恰好是 T1 中的操作, 利用 T1 的做法优化转移即可, 时间复杂度 $O(n + c)$.</p>
<p><strong>注意, 全局乘 $a$ 时, 如果 $a = 0$, 那么等价于全局赋值 $0$</strong>. 如果 T1 实现不精细, 在这里就会出现问题.</p>
<h4 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h4><div><div class="fold_hider"><div class="close hider_title">点击显示 / 隐藏 </div></div><div class="fold">
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LOJ #3111</span></span><br><span class="line"><span class="comment">// DeP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cctype&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> IO &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> MAXSIZE = <span class="number">1</span> &lt;&lt; <span class="number">18</span> | <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[MAXSIZE], *p1, *p2;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">Gc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> p1 == p2 &amp;&amp;</span><br><span class="line">            (p2 = (p1 = buf) + fread(buf, <span class="number">1</span>, MAXSIZE, <span class="built_in">stdin</span>), p1 == p2)? EOF: *p1++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(T&amp; x)</span> </span>&#123;</span><br><span class="line">        x = <span class="number">0</span>; <span class="keyword">int</span> f = <span class="number">0</span>, ch = Gc();</span><br><span class="line">        <span class="keyword">while</span> (!<span class="built_in">isdigit</span>(ch)) f |= ch == <span class="string">'-'</span>, ch = Gc();</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">isdigit</span>(ch)) x = x * <span class="number">10</span> + ch - <span class="string">'0'</span>, ch = Gc();</span><br><span class="line">        <span class="keyword">if</span> (f) x = -x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">using</span> IO::read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> LL;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1e5</span> + <span class="number">5</span>, P = <span class="number">1e9</span> + <span class="number">9</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fpow</span><span class="params">(<span class="keyword">int</span> base, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (b &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (b &amp; <span class="number">1</span>) ret = <span class="number">1L</span>L * ret * base % P;</span><br><span class="line">        base = <span class="number">1L</span>L * base * base % P, b &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exgcd</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b, <span class="keyword">int</span>&amp; x, <span class="keyword">int</span>&amp; y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!b) x = <span class="number">1</span>, y = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span> exgcd(b, a % b, y, x), y -= a / b * x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">inv</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span>&amp; a)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> x, y;</span><br><span class="line">    <span class="keyword">return</span> exgcd(a, P, x, y), (x % P + P) % P;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> SDOI &#123;</span><br><span class="line">    <span class="keyword">int</span> n, a, b, c, s;</span><br><span class="line">    <span class="built_in">unordered_map</span>&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; A;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> _n)</span> </span>&#123; n = _n, a = <span class="number">1</span>, b = c = s = <span class="number">0</span>, A.clear(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> LL <span class="title">Qry</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> s; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> LL <span class="title">Qry</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span>&amp; p)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="number">1L</span>L * a * ((A.count(p) &gt; <span class="number">0</span>)? A[p]: c) % P + b) % P;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">Sgn</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span>&amp; v)</span> </span>&#123;</span><br><span class="line">        a = <span class="number">1</span>, b = <span class="number">0</span>, c = v, s = <span class="number">1L</span>L * n * v % P, A.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">Sgn</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span>&amp; p, <span class="keyword">const</span> <span class="keyword">int</span>&amp; v)</span> </span>&#123;</span><br><span class="line">        s = (s - (<span class="number">1L</span>L * a * ((A.count(p) &gt; <span class="number">0</span>)? A[p]: c) % P + b) % P + P) % P;</span><br><span class="line">        A[p] = <span class="number">1L</span>L * (v - b + P) % P * inv(a) % P, s = (s + v) % P;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">Add</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span>&amp; v)</span> </span>&#123; b = (b + v) % P, s = (s + <span class="number">1L</span>L * n * v % P) % P; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">Mul</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span>&amp; v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!v) <span class="keyword">return</span> Sgn(v);</span><br><span class="line">        a = <span class="number">1L</span>L * a * v % P, b = <span class="number">1L</span>L * b * v % P, s = <span class="number">1L</span>L * s * v % P;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">using</span> SDOI::Sgn; <span class="keyword">using</span> SDOI::Add; <span class="keyword">using</span> SDOI::Mul; <span class="keyword">using</span> SDOI::Qry;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MatrixMul</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span>* f, <span class="keyword">int</span>* g, <span class="keyword">const</span> <span class="keyword">int</span> (*W)[<span class="number">5</span>])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; ++i)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">5</span>; ++j) g[i] = (g[i] + <span class="number">1L</span>L * f[j] * W[i][j] % P) % P;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n, m, C;</span><br><span class="line"><span class="keyword">int</span> A[MAXN], B[MAXN];</span><br><span class="line"><span class="keyword">int</span> pos[MAXN], g[MAXN][<span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PreMatrix</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x = C - <span class="number">2</span>, y = C - <span class="number">3</span>, yy = <span class="number">1L</span>L * y * y % P, xy = <span class="number">1L</span>L * x * y % P;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> W[<span class="number">5</span>][<span class="number">5</span>] = &#123;</span><br><span class="line">        &#123; <span class="number">0</span>, <span class="number">1</span>,   <span class="number">0</span>, <span class="number">2</span>*x, xy &#125;,</span><br><span class="line">        &#123; <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>*x,   <span class="number">0</span>, xy &#125;,</span><br><span class="line">        &#123; <span class="number">0</span>, <span class="number">1</span>,   x, x+y, yy &#125;,</span><br><span class="line">        &#123; <span class="number">1</span>, <span class="number">0</span>, x+y,   x, yy &#125;,</span><br><span class="line">        &#123; <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>*y, <span class="number">2</span>*y, <span class="keyword">int</span>((C * (C - <span class="number">7L</span>L) + <span class="number">13</span>) % P) &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    g[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) MatrixMul(g[i - <span class="number">1</span>], g[i], W);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">brute</span><span class="params">(<span class="keyword">int</span> l1, <span class="keyword">int</span> l2, <span class="keyword">int</span> r1, <span class="keyword">int</span> r2, <span class="keyword">int</span>* f)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> tmp[] = &#123; <span class="number">4</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">-1</span>, <span class="number">3</span>, <span class="number">-1</span>, <span class="number">1</span>, <span class="number">-1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">-1</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> f[tmp[(l1 == r1) | (l1 == r2) &lt;&lt; <span class="number">1</span> | (l2 == r1) &lt;&lt; <span class="number">2</span> | (l2 == r2) &lt;&lt; <span class="number">3</span>]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(<span class="keyword">int</span> l1, <span class="keyword">int</span> l2, <span class="keyword">int</span> r1, <span class="keyword">int</span> r2, <span class="keyword">int</span>* f)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> r = r1 | r2;</span><br><span class="line">    <span class="keyword">if</span> (!r1 &amp;&amp; r2 &gt; <span class="number">0</span>) swap(l1, l2);</span><br><span class="line">    <span class="keyword">if</span> (l1 == r) Sgn(f[<span class="number">2</span>]), Sgn(l2, f[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (l2 == r) Sgn(f[<span class="number">3</span>]), Sgn(l1, f[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">else</span> Sgn(f[<span class="number">4</span>]), Sgn(l1, f[<span class="number">3</span>]), Sgn(l2, f[<span class="number">2</span>]);</span><br><span class="line">    Sgn(r, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> l1, <span class="keyword">int</span> l2, <span class="keyword">int</span> r1, <span class="keyword">int</span> r2, <span class="keyword">int</span>* f)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> l = l1 | l2;</span><br><span class="line">    <span class="keyword">if</span> (!l1 &amp;&amp; l2 &gt; <span class="number">0</span>) swap(r1, r2);</span><br><span class="line">    <span class="keyword">if</span> (l == r1) <span class="keyword">return</span> (Qry() * f[<span class="number">2</span>] + Qry(r2) * (f[<span class="number">0</span>] - f[<span class="number">2</span>] + P)) % P;</span><br><span class="line">    <span class="keyword">if</span> (l == r2) <span class="keyword">return</span> (Qry() * f[<span class="number">3</span>] + Qry(r1) * (f[<span class="number">1</span>] - f[<span class="number">3</span>] + P)) % P;</span><br><span class="line">    <span class="keyword">return</span> (Qry() * f[<span class="number">4</span>] + Qry(r1) * (f[<span class="number">3</span>] - f[<span class="number">4</span>] + P) + Qry(r2) * (f[<span class="number">2</span>] - f[<span class="number">4</span>] + P)) % P;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">move</span><span class="params">(<span class="keyword">int</span> l1, <span class="keyword">int</span> l2, <span class="keyword">int</span> r1, <span class="keyword">int</span> r2, <span class="keyword">int</span>* f)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> l = l1 | l2, r = r1 | r2;</span><br><span class="line">    LL v, s = Qry();</span><br><span class="line">    <span class="keyword">if</span> (!l1 ^ !r1) &#123;</span><br><span class="line">        <span class="keyword">if</span> (l == r) Mul((f[<span class="number">1</span>] - f[<span class="number">3</span>] + P) % P), Add(s * f[<span class="number">3</span>] % P);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            v = Qry(r), s = (s - v + P) % P;</span><br><span class="line">            Mul((f[<span class="number">3</span>] - f[<span class="number">4</span>] + P) % P), Add((s * f[<span class="number">4</span>] + v * f[<span class="number">2</span>]) % P);</span><br><span class="line">            Sgn(l, (s * f[<span class="number">2</span>] + v * f[<span class="number">0</span>]) % P);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (l == r) Mul((f[<span class="number">0</span>] - f[<span class="number">2</span>] + P) % P), Add(s * f[<span class="number">2</span>] % P);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            v = Qry(r), s = (s - v + P) % P;</span><br><span class="line">            Mul((f[<span class="number">2</span>] - f[<span class="number">4</span>] + P) % P), Add((s * f[<span class="number">4</span>] + v * f[<span class="number">3</span>]) % P);</span><br><span class="line">            Sgn(l, (s * f[<span class="number">3</span>] + v * f[<span class="number">1</span>]) % P);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Sgn(r, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ONLINE_JUDGE</span></span><br><span class="line">    freopen(<span class="string">"input.in"</span>, <span class="string">"r"</span>, <span class="built_in">stdin</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// input</span></span><br><span class="line">    read(n), read(C);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) read(A[i]);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) read(B[i]);</span><br><span class="line">    <span class="comment">// check</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) <span class="keyword">if</span> (A[i] || B[i]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (A[i] == B[i]) <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"0"</span>), <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; n) &#123;</span><br><span class="line">            <span class="keyword">if</span> (A[i] &amp;&amp; A[i] == A[i + <span class="number">1</span>]) <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"0"</span>), <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (B[i] &amp;&amp; B[i] == B[i + <span class="number">1</span>]) <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"0"</span>), <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pos[++m] = i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> ans = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (!m) &#123;</span><br><span class="line">        ans = <span class="number">1L</span>L * C * (C - <span class="number">1</span>) % P * fpow((C * (C - <span class="number">3L</span>L) + <span class="number">3</span>) % P, n - <span class="number">1</span>) % P;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, ans), <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// init</span></span><br><span class="line">    SDOI::init(C), PreMatrix();</span><br><span class="line">    <span class="comment">// solve</span></span><br><span class="line">    <span class="keyword">int</span> u = A[pos[<span class="number">1</span>]], d = B[pos[<span class="number">1</span>]], t = fpow((C * (C - <span class="number">3L</span>L) + <span class="number">3</span>) % P, pos[<span class="number">1</span>] - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (u &amp;&amp; d) ans = t; <span class="keyword">else</span> Add(t), Sgn(u | d, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= m; ++i) &#123;</span><br><span class="line">        <span class="keyword">int</span> lu = u, ld = d, *f = g[pos[i] - pos[i - <span class="number">1</span>]];</span><br><span class="line">        u = A[pos[i]], d = B[pos[i]];</span><br><span class="line">        <span class="keyword">if</span> (u &amp;&amp; d) &#123;</span><br><span class="line">            <span class="keyword">if</span> (lu &amp;&amp; ld) ans = <span class="number">1L</span>L * ans * brute(lu, ld, u, d, f) % P;</span><br><span class="line">            <span class="keyword">else</span> ans = <span class="number">1L</span>L * ans * close(lu, ld, u, d, f) % P;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (lu &amp;&amp; ld) open(lu, ld, u, d, f); <span class="keyword">else</span> move(lu, ld, u, d, f);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!(u &amp;&amp; d)) ans = ans * Qry() % P;</span><br><span class="line">    ans = <span class="number">1L</span>L * ans * fpow((C * (C - <span class="number">3L</span>L) + <span class="number">3</span>) % P, n - pos[m]) % P;</span><br><span class="line">    <span class="comment">// output</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, ans);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>
<h3 id="「SDOI2019」世界地图"><a href="#「SDOI2019」世界地图" class="headerlink" title="「SDOI2019」世界地图"></a>「SDOI2019」世界地图</h3><h4 id="题目链接-2"><a href="#题目链接-2" class="headerlink" title="题目链接"></a>题目链接</h4><ul>
<li><a href="https://loj.ac/problem/3112" target="_blank" rel="noopener">https://loj.ac/problem/3112</a></li>
</ul>
<h4 id="解题思路-2"><a href="#解题思路-2" class="headerlink" title="解题思路"></a>解题思路</h4><p>首先有一个朴素的想法. 观察到 $1 &lt; L \le R &lt; m$, 预处理前缀 / 后缀的 MST, 每次查询区间 $[L,\ R]$ 时, 合并 $L$ 前以及 $R$ 后的 MST, 同时加入第一列和最后一列的边.</p>
<p>时间复杂度为 $O(m ^ 2 n \log nm + q n m\log nm)$, 快乐.</p>
<p>观察到题目中给定的是网格图, 对于前缀或后缀 MST, 除去边界两列, 其 “内部” 列不会再存在边同其相连. 换句话说, 每次合并 MST 时, 用到的部分只有 $2n$ 个边界两列节点, 其内部节点部分并不受影响.</p>
<p>那么, 每次只记录和这 $2n$ 个点相关的边, 并记录其余边的边权和, 称之为 “虚树”. 每次合并 MST 时, 取出相关的边跑 Kruksal, 之后对得到的生成树建虚树即可.</p>
<p>对于建虚树的部分, 为了保持 MST 的性质, 涉及到保留哪些节点以及对应边的边权问题. 我们称保留在虚树中的点为 “关键点”, 那么关键点需满足以下任一条件:</p>
<ol>
<li><p>设待合并的两棵虚树分别为 $L$, $R$, 那么 $L$ 中最靠前的部分, 以及 $R$ 中最靠后的部分一定是关键点.</p>
<p>这一部分并不受新增加的边影响, 显然要保留.</p>
</li>
<li><p>至少有两个儿子, 满足在儿子的子树内存在关键点.</p>
</li>
</ol>
<p>同时, 只需记录关键点之间最大边权作为合并后虚树边权即可. 根据 MST 的回路性质, 可以发现这是对的.</p>
<p>时间复杂度 $O(mn \log n + q n\log n)$.</p>
<h4 id="代码实现-2"><a href="#代码实现-2" class="headerlink" title="代码实现"></a>代码实现</h4><p>“为什么你们的代码都是一个叫 <code>MST</code> 的结构体, 然后都用一个叫 <code>merge</code> 的函数合并 ?”</p>
<div><div class="fold_hider"><div class="close hider_title">点击显示 / 隐藏 </div></div><div class="fold">
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LOJ #3112</span></span><br><span class="line"><span class="comment">// DeP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cctype&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEBUG(args...) fprintf(stderr, ##args)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> IO &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> MAXSIZE = <span class="number">1</span> &lt;&lt; <span class="number">18</span> | <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[MAXSIZE], *p1, *p2;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">Gc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> p1 == p2 &amp;&amp;</span><br><span class="line">            (p2 = (p1 = buf) + fread(buf, <span class="number">1</span>, MAXSIZE, <span class="built_in">stdin</span>), p1 == p2)? EOF: *p1++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(T&amp; x)</span> </span>&#123;</span><br><span class="line">        x = <span class="number">0</span>; <span class="keyword">int</span> f = <span class="number">0</span>, ch = Gc();</span><br><span class="line">        <span class="keyword">while</span> (!<span class="built_in">isdigit</span>(ch)) f |= ch == <span class="string">'-'</span>, ch = Gc();</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">isdigit</span>(ch)) x = x * <span class="number">10</span> + ch - <span class="string">'0'</span>, ch = Gc();</span><br><span class="line">        <span class="keyword">if</span> (f) x = -x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">using</span> IO::read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> LL;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1e2</span> + <span class="number">5</span>, MAXM = <span class="number">1e4</span> + <span class="number">5</span>, MAXV = MAXN &lt;&lt; <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> u, v, w;</span><br><span class="line">    Edge(<span class="keyword">int</span> _u, <span class="keyword">int</span> _v, <span class="keyword">int</span> _w): u(_u), v(_v), w(_w) &#123; &#125;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (<span class="keyword">const</span> Edge&amp; rhs) <span class="keyword">const</span> &#123; <span class="keyword">return</span> w &lt; rhs.w; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n, m, q, lim;</span><br><span class="line"><span class="keyword">unsigned</span> SA, SB, SC;</span><br><span class="line"></span><br><span class="line"><span class="built_in">vector</span>&lt;Edge&gt; E;</span><br><span class="line"><span class="keyword">int</span> Idx[MAXV], W1[MAXM][MAXN], W2[MAXM][MAXN];</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Graph &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span> <span class="keyword">int</span> nxt, to, w; &#125; edges[MAXV &lt;&lt; <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> head[MAXV], eidx;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> _n)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">memset</span>(head, <span class="number">-1</span>, (_n + <span class="number">1</span>) * <span class="keyword">sizeof</span> (<span class="keyword">int</span>)), eidx = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">AddEdge</span><span class="params">(<span class="keyword">int</span> from, <span class="keyword">int</span> to, <span class="keyword">int</span> w)</span> </span>&#123;</span><br><span class="line">        edges[++eidx] = (Edge)&#123; head[from], to, w &#125;, head[from] = eidx;</span><br><span class="line">        edges[++eidx] = (Edge)&#123; head[to], from, w &#125;, head[to] = eidx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">dfsPre</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> fa, <span class="keyword">const</span> <span class="keyword">int</span>&amp; tot)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> s = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> v, i = head[u]; ~i; i = edges[i].nxt)</span><br><span class="line">            <span class="keyword">if</span> ((v = edges[i].to) != fa) s += dfsPre(v, u, tot);</span><br><span class="line">        <span class="keyword">if</span> (s &gt;= <span class="number">2</span>) Idx[u] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> s + Idx[u] &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> fa, <span class="keyword">int</span> lst, <span class="keyword">int</span> w, LL&amp; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Idx[u] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (lst &gt; <span class="number">0</span>) E.push_back(::Edge(Idx[lst], Idx[u], w));</span><br><span class="line">            lst = u, s -= w, w = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> v, i = head[u]; ~i; i = edges[i].nxt)</span><br><span class="line">            <span class="keyword">if</span> ((v = edges[i].to) != fa) dfs(v, u, lst, max(w, edges[i].w), s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> DSU &#123;</span><br><span class="line">    <span class="keyword">int</span> fa[MAXV];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span>&amp; _n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= _n; ++i) fa[i] = i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">findfa</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span>&amp; u)</span> </span>&#123; <span class="keyword">return</span> fa[u] == u? u: fa[u] = findfa(fa[u]); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">join</span><span class="params">(<span class="keyword">int</span> fu, <span class="keyword">int</span> fv)</span> </span>&#123;</span><br><span class="line">        fu = findfa(fu), fv = findfa(fv);</span><br><span class="line">        <span class="keyword">return</span> (fu == fv)? <span class="literal">false</span>: (fa[fv] = fu, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MST</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> v; LL s;</span><br><span class="line">    <span class="built_in">vector</span>&lt;Edge&gt; E;</span><br><span class="line"></span><br><span class="line">    MST() &#123; &#125;</span><br><span class="line">    MST(<span class="keyword">int</span>* W) &#123;</span><br><span class="line">        v = n, s = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++i) E.push_back(Edge(i, i + <span class="number">1</span>, W[i]));</span><br><span class="line">    &#125;</span><br><span class="line">    MST(<span class="keyword">int</span> _v, LL _s, <span class="keyword">const</span> <span class="built_in">vector</span>&lt;Edge&gt;&amp; _E): v(_v), s(_s), E(_E) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> LL <span class="title">calc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LL ret = s;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; e: E) ret += e.w;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; pre[MAXM], suf[MAXM];</span><br><span class="line"></span><br><span class="line"><span class="function">MST <span class="title">Mrg</span><span class="params">(<span class="keyword">const</span> MST&amp; L, <span class="keyword">const</span> MST&amp; R, <span class="keyword">const</span> <span class="keyword">int</span> *W)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> tot = L.v + R.v;</span><br><span class="line">    <span class="comment">// init</span></span><br><span class="line">    E.clear(), DSU::init(tot), Graph::init(tot);</span><br><span class="line">    <span class="comment">// Kruskal</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> Edge&amp; e: L.E) E.push_back(e);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> Edge&amp; e: R.E)</span><br><span class="line">        E.push_back(Edge(L.v + e.u, L.v + e.v, e.w));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i)</span><br><span class="line">        E.push_back(Edge(L.v - n + i, L.v + i, W[i]));</span><br><span class="line">    sort(E.begin(), E.end());</span><br><span class="line">    LL s = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> Edge&amp; e: E)</span><br><span class="line">        <span class="keyword">if</span> (DSU::join(e.u, e.v)) Graph::AddEdge(e.u, e.v, e.w), s += e.w;</span><br><span class="line">    <span class="comment">// build virtual tree</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> u = <span class="number">1</span>; u &lt;= tot; ++u)</span><br><span class="line">        Idx[u] = (u &lt;= n || u &gt; tot - n);</span><br><span class="line">    Graph::dfsPre(<span class="number">1</span>, <span class="number">0</span>, tot);</span><br><span class="line">    <span class="keyword">int</span> idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= tot; ++i)</span><br><span class="line">        <span class="keyword">if</span> (Idx[i] &gt; <span class="number">0</span>) Idx[i] = ++idx;</span><br><span class="line">    E.clear(), Graph::dfs(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, s);</span><br><span class="line">    <span class="keyword">return</span> MST(idx, L.s + R.s + s, E);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">Rnd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SA ^= SA &lt;&lt; <span class="number">16</span>, SA ^= SA &gt;&gt; <span class="number">5</span>, SA ^= SA &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> t = SA;</span><br><span class="line">    SA = SB, SB = SC, SC ^= t ^ SA;</span><br><span class="line">    <span class="keyword">return</span> SC % lim + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ONLINE_JUDGE</span></span><br><span class="line">    freopen(<span class="string">"input.in"</span>, <span class="string">"r"</span>, <span class="built_in">stdin</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// input</span></span><br><span class="line">    read(n), read(m);</span><br><span class="line">    read(SA), read(SB), read(SC), read(lim);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= m; ++j) W1[j][i] = Rnd();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++i)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= m; ++j) W2[j][i] = Rnd();</span><br><span class="line">    <span class="comment">// solve</span></span><br><span class="line">    pre[<span class="number">1</span>] = MST(W2[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; m; ++i)</span><br><span class="line">        pre[i] = Mrg(pre[i - <span class="number">1</span>], MST(W2[i]), W1[i - <span class="number">1</span>]);</span><br><span class="line">    suf[m] = MST(W2[m]);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = m - <span class="number">1</span>; i &gt; <span class="number">1</span>; --i)</span><br><span class="line">        suf[i] = Mrg(MST(W2[i]), suf[i + <span class="number">1</span>], W1[i]);</span><br><span class="line">    <span class="comment">// output</span></span><br><span class="line">    read(q);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> L, R; q; --q) &#123;</span><br><span class="line">        read(L), read(R);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, Mrg(suf[R + <span class="number">1</span>], pre[L - <span class="number">1</span>], W1[m]).calc());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>
<h3 id="「SDOI2019」热闹的聚会与尴尬的聚会"><a href="#「SDOI2019」热闹的聚会与尴尬的聚会" class="headerlink" title="「SDOI2019」热闹的聚会与尴尬的聚会"></a>「SDOI2019」热闹的聚会与尴尬的聚会</h3><h4 id="题目链接-3"><a href="#题目链接-3" class="headerlink" title="题目链接"></a>题目链接</h4><ul>
<li><a href="https://loj.ac/problem/3113" target="_blank" rel="noopener">https://loj.ac/problem/3113</a></li>
</ul>
<h4 id="解题思路-3"><a href="#解题思路-3" class="headerlink" title="解题思路"></a>解题思路</h4><p>清新题.</p>
<p>首先有 $\frac{n}{p + 1} &lt; \lfloor \frac{n}{p + 1} \rfloor + 1 \le q + 1$, 也就是 $n &lt; (p + 1) (q + 1)$.</p>
<p>再进一步转换, 也就是求尽量大的 $p$, $q$. 那么问题可拆分成两部分:</p>
<ul>
<li><p>求 $G$ 点集的某个子集 $V’$, 以 $V’$ 和 $G$ 中对应边构成 $G$ 的一张子图 $G’$, 使得 $G’$ 中度数最小点的度数为 $p$.</p>
</li>
<li><p>求 $G$ 的最大独立集, 使其大小 $q$ 满足 $n &lt; (p + 1) (q + 1)$.</p>
</li>
</ul>
<p>对于 $p$, 一个显然的思路是依次删除度数尽量小的点, 并在删点的过程中维护当前得到的最大 $p$ 值.</p>
<p>对于 $q$, 直接做显然是 NPC. 考虑一个贪心, 每次选择度数最小的点, 然后将这个点周围的点删去, 更新其余点的度数.</p>
<p>考虑如何证明这个做法的正确性.</p>
<p>求一个可行的 $q$ 时, 删去的节点不超过 $p$ 个. 即 $q \ge \lceil \frac{n}{p + 1} \rceil$. 进行一些转化, 有</p>
<script type="math/tex; mode=display">\frac{n}{p + 1} <\lceil \frac{n}{p + 1} \rceil +1 \le q + 1</script><script type="math/tex; mode=display">n < (p + 1) (q + 1)</script><p>这就是要证的.</p>
<p>时间复杂度大概是 $O((n + m) \log m)$? 感觉很假…</p>
<h4 id="代码实现-3"><a href="#代码实现-3" class="headerlink" title="代码实现"></a>代码实现</h4><div><div class="fold_hider"><div class="close hider_title">点击显示 / 隐藏 </div></div><div class="fold">
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LOJ #3113</span></span><br><span class="line"><span class="comment">// DeP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cctype&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> IO &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> MAXSIZE = <span class="number">1</span> &lt;&lt; <span class="number">18</span> | <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[MAXSIZE], *p1, *p2;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">Gc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> p1 == p2 &amp;&amp;</span><br><span class="line">            (p2 = (p1 = buf) + fread(buf, <span class="number">1</span>, MAXSIZE, <span class="built_in">stdin</span>), p1 == p2)? EOF: *p1++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(T&amp; x)</span> </span>&#123;</span><br><span class="line">        x = <span class="number">0</span>; <span class="keyword">int</span> f = <span class="number">0</span>, ch = Gc();</span><br><span class="line">        <span class="keyword">while</span> (!<span class="built_in">isdigit</span>(ch)) f |= ch == <span class="string">'-'</span>, ch = Gc();</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">isdigit</span>(ch)) x = x * <span class="number">10</span> + ch - <span class="string">'0'</span>, ch = Gc();</span><br><span class="line">        <span class="keyword">if</span> (f) x = -x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">using</span> IO::read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1e4</span> + <span class="number">5</span>, MAXM = <span class="number">1e5</span> + <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Item</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> d, u;</span><br><span class="line">    Item(<span class="keyword">int</span> _d, <span class="keyword">int</span> _u): d(_d), u(_u) &#123; &#125;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (<span class="keyword">const</span> Item&amp; rhs) <span class="keyword">const</span> &#123; <span class="keyword">return</span> d &gt; rhs.d; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n, m;</span><br><span class="line"><span class="keyword">int</span> deg[MAXN];</span><br><span class="line"></span><br><span class="line">priority_queue&lt;Item&gt; PQ;</span><br><span class="line"><span class="keyword">int</span> vis[MAXN], Time;</span><br><span class="line"><span class="keyword">int</span> f[MAXN], A[MAXN], B[MAXN], nA, nB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Graph &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span> <span class="keyword">int</span> nxt, to; &#125; edges[MAXM &lt;&lt; <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> head[MAXN], eidx;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123; <span class="built_in">memset</span>(head, <span class="number">-1</span>, <span class="keyword">sizeof</span> head), eidx = <span class="number">1</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">AddEdge</span><span class="params">(<span class="keyword">int</span> from, <span class="keyword">int</span> to)</span> </span>&#123;</span><br><span class="line">        edges[++eidx] = (Edge)&#123; head[from], to &#125;, head[from] = eidx;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Lively</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> Rmv[MAXN], nR, p, limit;</span><br><span class="line">    ++Time, limit = nR = <span class="number">0</span>, p = n;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> u = <span class="number">1</span>; u &lt;= n; ++u)</span><br><span class="line">        p = min(p, f[u]), PQ.push(Item(f[u] = deg[u], u));</span><br><span class="line">    <span class="keyword">while</span> (!PQ.empty()) &#123;</span><br><span class="line">        <span class="keyword">int</span> u = PQ.top().u, d = PQ.top().d; PQ.pop();</span><br><span class="line">        <span class="keyword">if</span> (d != f[u]) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (p &lt; d) p = d, limit = nR;</span><br><span class="line">        Rmv[++nR] = u, vis[u] = Time;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> v, i = Graph::head[u]; ~i; i = Graph::edges[i].nxt) &#123;</span><br><span class="line">            <span class="keyword">if</span> (vis[v = Graph::edges[i].to] == Time) <span class="keyword">continue</span>;</span><br><span class="line">            PQ.push(Item(--f[v], v));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    nA = <span class="number">0</span>, ++Time;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= limit; ++i) vis[Rmv[i]] = Time;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> u = <span class="number">1</span>; u &lt;= n; ++u)</span><br><span class="line">        <span class="keyword">if</span> (vis[u] != Time) A[++nA] = u;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Awkward</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    nB = <span class="number">0</span>, ++Time;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> u = <span class="number">1</span>; u &lt;= n; ++u)</span><br><span class="line">        PQ.push(Item(f[u] = deg[u], u));</span><br><span class="line">    <span class="keyword">while</span> (!PQ.empty()) &#123;</span><br><span class="line">        <span class="keyword">int</span> u = PQ.top().u, d = PQ.top().d; PQ.pop();</span><br><span class="line">        <span class="keyword">if</span> (d != f[u] || vis[u] == Time) <span class="keyword">continue</span>;</span><br><span class="line">        B[++nB] = u, vis[u] = Time;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> v, i = Graph::head[u]; ~i; i = Graph::edges[i].nxt) &#123;</span><br><span class="line">            <span class="keyword">if</span> (vis[v = Graph::edges[i].to] == Time) <span class="keyword">continue</span>;</span><br><span class="line">            vis[v] = Time;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> x, j = Graph::head[v]; ~j; j = Graph::edges[j].nxt)</span><br><span class="line">                <span class="keyword">if</span> (vis[x = Graph::edges[j].to] != Time) PQ.push(Item(--f[x], x));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ONLINE_JUDGE</span></span><br><span class="line">    freopen(<span class="string">"input.in"</span>, <span class="string">"r"</span>, <span class="built_in">stdin</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">int</span> Ti; read(Ti);</span><br><span class="line">    <span class="keyword">while</span> (Ti--) &#123;</span><br><span class="line">        <span class="comment">// init</span></span><br><span class="line">        Graph::init();</span><br><span class="line">        <span class="built_in">memset</span>(deg, <span class="number">0</span>, <span class="keyword">sizeof</span> deg);</span><br><span class="line">        <span class="comment">// input</span></span><br><span class="line">        read(n), read(m);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> u, v, i = <span class="number">1</span>; i &lt;= m; ++i) &#123;</span><br><span class="line">            read(u), read(v);</span><br><span class="line">            Graph::AddEdge(u, v), Graph::AddEdge(v, u);</span><br><span class="line">            ++deg[u], ++deg[v];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// solve</span></span><br><span class="line">        Lively(), Awkward();</span><br><span class="line">        <span class="comment">// output</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d "</span>, nA);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= nA; ++i) <span class="built_in">printf</span>(<span class="string">"%d%c"</span>, A[i], <span class="string">" \n"</span>[i == nA]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d "</span>, nB);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= nB; ++i) <span class="built_in">printf</span>(<span class="string">"%d%c"</span>, B[i], <span class="string">" \n"</span>[i == nB]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>
<h3 id="「SDOI2019」移动金币"><a href="#「SDOI2019」移动金币" class="headerlink" title="「SDOI2019」移动金币"></a>「SDOI2019」移动金币</h3><h4 id="题目链接-4"><a href="#题目链接-4" class="headerlink" title="题目链接"></a>题目链接</h4><ul>
<li><a href="https://loj.ac/problem/3114" target="_blank" rel="noopener">https://loj.ac/problem/3114</a></li>
</ul>
<h4 id="解题思路-4"><a href="#解题思路-4" class="headerlink" title="解题思路"></a>解题思路</h4><p><del>似乎是单纯的 Staircase Nim 计数?</del></p>
<p>对题意做一步转化. 将移动金币的过程看作一定量的格子移动到了金币后. 那么, 将金币看作阶梯的分界, 移动金币看作将阶梯上的石子移动到下一层, 显然就是 “阶梯博弈” 的模型了.</p>
<p>阶梯博弈中, 先手必胜的条件是所有编号为奇 (注意这里的编号从 $0$ 开始) 的阶梯上石子个数异或和不为 $0$. 此时根据后手的决策讨论一番即可得出证明.</p>
<p>那么, 现在有 $n - m$ 颗石子, 要将这些石子放在在 $m + 1$ 个阶梯上, 求满足限制的方案数.</p>
<p>注意到 “异或和不为 $0$” 的条件不好处理, 于是改为处理编号为奇数的阶梯上异或和为 $0$ 的方案数. 考虑二进制下按位 DP, 则需要满足的条件为每一位出现 $1$ 的次数为偶数次.</p>
<p>设 $f(i, j)$ 表示处理完前 $i$ 位, 剩余 $j$ 个石子的方案数. 为满足异或和为 $0$ 的条件, 需要选择偶数个阶梯, 在这些阶梯上放置 $2 ^ i$ 个石子. </p>
<p>记编号为奇数的阶梯个数为 $q = \lfloor \frac{m + 1}{2} \rfloor$, 有</p>
<script type="math/tex; mode=display">f(i, j) = \sum_{k \bmod 2 = 0} ^ q f(i + 1, j + k \cdot 2 ^ {i})</script><p>记编号为偶数的阶梯个数为 $p = \lceil \frac{m + 1}{2} \rceil$, 最终答案为</p>
<script type="math/tex; mode=display">\binom{n}{m} - \sum_{i = 0} ^ {n - m} \binom{i + p - 1}{i} \cdot f\big(0,\ i\big)</script><p>时间复杂度 $O(nm\log n)$.</p>
<h4 id="代码实现-4"><a href="#代码实现-4" class="headerlink" title="代码实现"></a>代码实现</h4><div><div class="fold_hider"><div class="close hider_title">点击显示 / 隐藏 </div></div><div class="fold">
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LOJ #3114</span></span><br><span class="line"><span class="comment">// DeP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">15e4</span> + <span class="number">5</span>, MAXM = <span class="number">55</span>, LOG = <span class="number">19</span>, P = <span class="number">1e9</span> + <span class="number">9</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fac[MAXN], ifac[MAXN];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fpow</span><span class="params">(<span class="keyword">int</span> base, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (b &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (b &amp; <span class="number">1</span>) ret = <span class="number">1L</span>L * ret * base % P;</span><br><span class="line">        base = <span class="number">1L</span>L * base * base % P, b &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PolyPre</span><span class="params">(<span class="keyword">int</span> N)</span> </span>&#123;</span><br><span class="line">    fac[<span class="number">0</span>] = ifac[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; ++i) fac[i] = <span class="number">1L</span>L * i * fac[i - <span class="number">1</span>] % P;</span><br><span class="line">    ifac[N] = fpow(fac[N], P - <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = N; i; --i) ifac[i - <span class="number">1</span>] = <span class="number">1L</span>L * ifac[i] * i % P;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">C</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> m)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> n &lt; m? <span class="number">0</span>: <span class="number">1L</span>L * fac[n] * ifac[n - m] % P * ifac[m] % P;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n, m;</span><br><span class="line"><span class="keyword">int</span> f[LOG][MAXN];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// input</span></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>, &amp;n, &amp;m);</span><br><span class="line">    <span class="comment">// sovle</span></span><br><span class="line">    <span class="keyword">if</span> (n &lt; m) <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"0"</span>), <span class="number">0</span>;</span><br><span class="line">    PolyPre(n + m);</span><br><span class="line">    <span class="keyword">int</span> q = (m + <span class="number">1</span>) / <span class="number">2</span>, lg2 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> ((<span class="number">1</span> &lt;&lt; lg2) &lt;= n - m) ++lg2;</span><br><span class="line">    f[lg2][n - m] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = lg2 - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= n - m; ++j)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt;= q &amp;&amp; j + k * (<span class="number">1L</span>L &lt;&lt; i) &lt;= n - m; k += <span class="number">2</span>)</span><br><span class="line">                f[i][j] = (f[i][j] + <span class="number">1L</span>L * C(q, k) * f[i + <span class="number">1</span>][j + k * (<span class="number">1</span> &lt;&lt; i)] % P) % P;</span><br><span class="line">    <span class="keyword">int</span> ans = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= n - m; ++i)</span><br><span class="line">        ans = (ans + <span class="number">1L</span>L * C(i + (m + <span class="number">2</span>) / <span class="number">2</span> - <span class="number">1</span>, i) * f[<span class="number">0</span>][i] % P) % P;</span><br><span class="line">    <span class="comment">// output</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, (C(n, m) - ans + P) % P);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>
<h3 id="「SDOI2019」连续子序列"><a href="#「SDOI2019」连续子序列" class="headerlink" title="「SDOI2019」连续子序列"></a>「SDOI2019」连续子序列</h3><h4 id="题目链接-5"><a href="#题目链接-5" class="headerlink" title="题目链接"></a>题目链接</h4><ul>
<li><a href="https://loj.ac/problem/3115" target="_blank" rel="noopener">https://loj.ac/problem/3115</a></li>
</ul>
<h4 id="解题思路-5"><a href="#解题思路-5" class="headerlink" title="解题思路"></a>解题思路</h4><p>根据 <del>T.M. 序列</del> $\text{Thue−Morse}$ 序列的定义, 手玩之后可以发现:</p>
<ol>
<li><p>序列从 <code>&#39;0&#39;</code> 出发, 定义 “扩充” 为长度为 $n$ 的序列的每一个字符 <code>&#39;0&#39; --&gt; &#39;01&#39;</code>, <code>&#39;1&#39; --&gt; &#39;10&#39;</code>, 从而得到另一个长度 $2n$ 序列. 不断扩充后得到的序列, 恰好是 Thus-Morse 序列.</p>
</li>
<li><p>任何子串包含 <code>111</code> 或 <code>000</code> 的串一定不是 Thus-Morse 序列的子串.</p>
<p>考虑到性质 1 给出的构造 Thus-Morse 序列的方法, 至多有两个相同字符相邻.</p>
</li>
<li><p>长度 $&gt; 3$ 的 Thus-Morse 序列子串 $S$ 一定是由唯一的某个 Thus-Morse 序列子串生成的.</p>
<p>证明参见: <a href="https://okazakiyumemi.github.io/blog/%E3%80%8CSDOI2019%E3%80%8D%E8%BF%9E%E7%BB%AD%E5%AD%90%E5%BA%8F%E5%88%97/" target="_blank" rel="noopener">https://okazakiyumemi.github.io/blog/「SDOI2019」连续子序列/</a>.</p>
</li>
</ol>
<p>此时得到了一个分治做法: 每次由 $S$ 得到扩充操作之前的串 $T$, 然后分治计算 $T$ 的答案再加以合并.</p>
<p>注意在得出扩充操作前的串 $T$ 时, 需讨论从 $S$ 开头匹配, 以及在 $S$ 前增加一个字符后两种情况. 后者可看作 “$T$ 是 T.M. 的连续子序列” 条件下多考虑的情况.</p>
<p>此外, $|S| \le 3$ 时的问题仍然没有解决.</p>
<p>除去 $|S| = 2$ 或 $|S| = 3$ 的一些特殊情况, 剩余的问题在于 $|S| = 1$.</p>
<p>设 $f(k)$ 表示一个字符后添加恰好 $k$ 个字符, 得出合法序列的方案数. 不难发现, 这个字符为 <code>0</code> / <code>1</code> 并不影响 $f(k)$ 的值, 并有</p>
<script type="math/tex; mode=display">f(k) = f(\lfloor \frac{k}{2} \rfloor) + f(\lfloor \frac{k + 1}{2} \rfloor)</script><p>记忆化即可. 并存在初值 $f(0) = 1,\ f(1) = 2,\ f(2) = 3$.</p>
<p>时间复杂度大概是 $O(T \cdot (|S| + \log k))$?</p>
<h4 id="代码实现-5"><a href="#代码实现-5" class="headerlink" title="代码实现"></a>代码实现</h4><div><div class="fold_hider"><div class="close hider_title">点击显示 / 隐藏 </div></div><div class="fold">
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LOJ #3115</span></span><br><span class="line"><span class="comment">// DeP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> LL;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> P = <span class="number">1e9</span> + <span class="number">9</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">(<span class="keyword">const</span> LL&amp; k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">unordered_map</span>&lt;LL, <span class="keyword">int</span>&gt; mf;</span><br><span class="line">    <span class="keyword">if</span> (k &lt; <span class="number">3</span>) <span class="keyword">return</span> k + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> (mf.count(k) &gt; <span class="number">0</span>)? mf[k]: mf[k] = (f(k / <span class="number">2</span>) + f((k + <span class="number">1</span>) / <span class="number">2</span>)) % P;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">compress</span><span class="params">(<span class="keyword">const</span> <span class="built_in">string</span>&amp; S, <span class="built_in">string</span>&amp; T)</span> </span>&#123;</span><br><span class="line">    T.clear();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; S.size(); i += <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i + <span class="number">1</span> != S.size() &amp;&amp; S[i] == S[i + <span class="number">1</span>]) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        T += S[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">solve</span><span class="params">(<span class="keyword">const</span> <span class="built_in">string</span>&amp; S, <span class="keyword">const</span> LL&amp; K)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> lgt = (<span class="keyword">int</span>) S.size();</span><br><span class="line">    <span class="keyword">if</span> (lgt == <span class="number">1</span>) <span class="keyword">return</span> f(K);</span><br><span class="line">    <span class="keyword">if</span> (lgt == <span class="number">2</span> &amp;&amp; K == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// 10 / 01, 11 / 00</span></span><br><span class="line">    <span class="keyword">if</span> (lgt == <span class="number">2</span> &amp;&amp; K == <span class="number">1</span>) <span class="keyword">return</span> (S[<span class="number">0</span>] == S[<span class="number">1</span>])? <span class="number">1</span>: <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (lgt == <span class="number">3</span> &amp;&amp; K == <span class="number">0</span>) <span class="keyword">return</span> S[<span class="number">0</span>] != S[<span class="number">1</span>] || S[<span class="number">1</span>] != S[<span class="number">2</span>]; <span class="comment">// 111, 000</span></span><br><span class="line">    <span class="built_in">string</span> T;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (compress(S, T))</span><br><span class="line">        ret = (ret + solve(T, (K + !(lgt &amp; <span class="number">1</span>)) / <span class="number">2</span>)) % P;</span><br><span class="line">    <span class="keyword">if</span> (compress((S[<span class="number">0</span>] == <span class="string">'0'</span>? <span class="string">'1'</span>: <span class="string">'0'</span>) + S, T))</span><br><span class="line">        ret = (ret + solve(T, (K + (lgt &amp; <span class="number">1</span>)) / <span class="number">2</span>)) % P;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ONLINE_JUDGE</span></span><br><span class="line">    freopen(<span class="string">"input.in"</span>, <span class="string">"r"</span>, <span class="built_in">stdin</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    ios::sync_with_stdio(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">int</span> Ti;</span><br><span class="line">    <span class="built_in">cin</span> &gt;&gt; Ti;</span><br><span class="line">    <span class="keyword">for</span> (LL K; Ti; --Ti) &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="built_in">string</span> str;</span><br><span class="line">        <span class="built_in">cin</span> &gt;&gt; str &gt;&gt; K;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; solve(str, K) &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>
<hr>

  </div>
  <footer class="article-footer">
    
  <div class="cc">
    <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/deed.z" target="_blank" title="署名-非商业性使用-相同方式共享">
      <img src="/images/cc/cc.png">
      
          <img src="/images/cc/by.png">
        
          <img src="/images/cc/nc.png">
        
          <img src="/images/cc/sa.png">
      
      <span>
        本作品采用知识共享 署名-非商业性使用-相同方式共享 4.0 国际许可协议进行许可。
      </span>
    </a>
  </div>


  </footer>
  
</article>


    <link rel="stylesheet" href="/css/gitalk.css">
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <div id="gitalk-container"></div>
    <script src="/scripts/gitalk.js"></script>




          <div class="main-footer">
  
    © 2020 DepletedPrism&#39;s Blog
    
	- Powered by <a href="http://hexo.io" target="_blank">Hexo</a> - Theme <a href="https://github.com/denjones/hexo-theme-chan" target="_blank">Chan</a>
  
</div>

      
        </div>
      
    </div>
  </div>
  <script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

  <link rel="stylesheet" href="/PhotoSwipe/photoswipe.css">
  <link rel="stylesheet" href="/PhotoSwipe/default-skin/default-skin.css">

  <!-- Root element of PhotoSwipe. Must have class pswp. -->
  <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
             It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

      <!-- Container that holds slides.
                PhotoSwipe keeps only 3 of them in the DOM to save memory.
                Don't modify these 3 pswp__item elements, data is added later on. -->
      <div class="pswp__container">
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
      </div>

      <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
      <div class="pswp__ui pswp__ui--hidden">

        <div class="pswp__top-bar">

          <!--  Controls are self-explanatory. Order can be changed. -->

          <div class="pswp__counter"></div>

          <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

          <button class="pswp__button pswp__button--share" title="Share"></button>

          <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

          <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

          <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
          <!-- element will get class pswp__preloader--active when preloader is running -->
          <div class="pswp__preloader">
            <div class="pswp__preloader__icn">
              <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
          <div class="pswp__share-tooltip"></div>
        </div>

        <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

        <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

        <div class="pswp__caption">
          <div class="pswp__caption__center"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/PhotoSwipe/photoswipe.js"></script>
  <script src="/PhotoSwipe/photoswipe-ui-default.js"></script>


<script src="/perfect-scrollbar/js/min/perfect-scrollbar.min.js"></script>
<script src="/scripts/main.js"></script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<!--script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

</body>
</html>
--></body></html>